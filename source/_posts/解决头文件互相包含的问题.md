---
title: 解决头文件互相包含的问题
date: 2018-06-16 18:55:54
tags:
---

## 具体情景

​	之前在编译一个项目的时候，总是出现部分内容未定义的错误，后来发现原因是两个头文件互相包含了。简化之后的代码如下（均在同一级目录）：

```c++
//Foo.h
#pragma once
#include "Bar.h"

class Base {};
class Foo
{
public:
	Bar * BarCreator();
};

//Bar.h
#pragma once
#include "Foo.h"

class Bar :public Base
{
};

//Foo.cpp
#include "Foo.h"
Bar* Foo::BarCreator()
{
	return new Bar;
}
```

​	如果使用#ifndef头文件保护或者#pragma once都是不能解决上面的问题的，它们是用来解决头文件重复包含而非互相包含的问题。原因也很简单：头文件A与头文件B都需要对方的定义，而此时AB都没有编译完成，因此出现部分内容未定义的错误。

## 解决方法

### 1.重构

​	这个是最推荐的办法，这样的代码结构肯定是有问题的，两个头文件互相耦合，不便于以后的扩展。上面代码的具体修改方法很简单，就不贴出来了。

### 2.使用声明

​	实际上我使用的还是这种办法，因为具体项目中两个头文件之间耦合已经比较严重了，需要修改很多地方，并且我懒......所以就偷了下懒hhh.

​	观察发现，在Foo.h中用到了class Bar的部分就只是一个成员函数的返回值Bar*，而指针所占用的大小是与具体的类定义无关的，因此，只需要把

```c++
#include "Bar.h"
```

替换为声明

```c++
class Bar;
//注意不是class Bar{};
```

在Foo.cpp中有new Bar，此时就需要Bar的具体定义了，因此在Foo.cpp中添加

```c++
#include "Bar.h"
```

这样就可以编译通过了。

## 附

​	第二种方法中的前置声明有优点，也有缺点，具体可以见[Google 开源项目风格指南 -前置声明](http://zh-google-styleguide.readthedocs.io/en/latest/google-cpp-styleguide/headers/#forward-declarations)中的描述。