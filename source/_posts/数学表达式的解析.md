---
title: 数学表达式的解析
date: 2018-05-15 22:07:14
tags:
---

## [项目地址](https://github.com/cildhdi/function_parsing)

在做之前bing了一下数学表达式的解析，搜到的一般都是对纯数字表达式的解析，没有看到对含有自变量的表达式的解析，反正闲得慌，就随便写了写。

## 需要实现的

在一个最最基本的纯数字表达式里，数字肯定是有的，还有一些操作符（比如加减乘除和乘方等），所以这些肯定是要支持的。还有一个比较头疼的就是括号，它可以改变前面说的一些操作符的优先级，应该是要重点解决的。另外，还要能够含有自变量，在解析之后，能够通过传入自变量，获取函数表达式的值，如果能实现，常规的纯数字表达式应该也没有问题，相当于一个常量函数。对函数表达式求导本来是开始没打算实现的，后来发现存储函数表达式的方式刚好很适合实现这个功能，就顺便写了一下。

## 开始敲敲敲辣

### 函数表达式的存储

​	一个比较复杂的函数表达式，例如
$$
x*(x+1)^2+5*x
$$
可以看作两个表达式之和，这两个表达式又可以拆分为更多的表达式，它们的类型都不一定相同，可能是加法也可能是乘法，但是都能够对它们进行求值（value）操作。相同的操作，对于不同的表达式有不同的实现方法，到这里就能自然地想到多态了。所以，定义一个函数的抽象基类base_function：

```c++
class base_function
{
public:
	virtual std::string str() = 0;//返回表达式字符串
	virtual double value(double x) = 0;//返回值
	virtual base_function_ptr derivative() = 0;//返回导函数
};
```

其他的一些类：constant_function，add_function，minus_function，multiply_function，divide_function等都继承自它，另外一个子类independent_variable就是用于标识自变量的，在value(x)的实现里直接返回了参数值x。

​	在上述子类中，对应的操作符的操作数全部都被看作函数表达式，因此也是用base_function_ptr来保存，例如add_function：

```c++
//function_parsing.h
class add_function :public base_function
{
private:
	base_function_ptr m_lhs;
	base_function_ptr m_rhs;
public:
	add_function(base_function_ptr lhs, base_function_ptr rhs);
	std::string str();
	double value(double x);
	base_function_ptr derivative();
};

//function_parsing.cpp
add_function::add_function(base_function_ptr lhs, base_function_ptr rhs) :m_lhs(lhs), m_rhs(rhs)
{
}

std::string add_function::str()
{
	return "(" + m_lhs->str() + "+" + m_rhs->str() + ")";
}

double add_function::value(double x)
{
	return m_lhs->value(x) + m_rhs->value(x);
}

base_function_ptr add_function::derivative()
{
	return std::make_shared<add_function>(m_lhs->derivative(), m_rhs->derivative());
}
```

其他的子类实现方式都类似，这样就能通过层层求值，获取整个函数表达式的值。

​	上面的代码中，含有的derivative成员函数是用来求导函数的。求导这个功能，大部分实现都是通过取一个Δx，返回f(x)在x处的导数值，但是在上面的代码中，直接把求导法则写入了实现中，因而能够直接返回导函数，可通过value来获取导函数对应x的值。
